"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cdk = require("@aws-cdk/core");
const lambda = require("@aws-cdk/aws-lambda");
const sfn = require("@aws-cdk/aws-stepfunctions");
const iam = require("@aws-cdk/aws-iam");
const tasks = require("@aws-cdk/aws-stepfunctions-tasks");
const logs = require("@aws-cdk/aws-logs");
const path = require("path");
const aws_kms_1 = require("@aws-cdk/aws-kms");
const aws_cognito_1 = require("@aws-cdk/aws-cognito");
const core_1 = require("@aws-cdk/core");
const aws_stepfunctions_1 = require("@aws-cdk/aws-stepfunctions");
class LoadTestStack extends cdk.Stack {
    constructor(scope, id, props = {}) {
        var _a, _b, _c, _d, _e, _f;
        super(scope, id, props);
        const prefix = "apiloadtest-";
        //INPUT PARAMETERS
        const api_url = new core_1.CfnParameter(this, "apiGatewayUrl", {
            type: "String",
            description: "API Gateway URL being load tested."
        });
        //TODO: register with Cognito
        const customEmailSender = new lambda.Function(this, 'customEmailSender', {
            code: new lambda.AssetCode('lambda/customEmailSender'),
            handler: 'index.handler',
            runtime: lambda.Runtime.NODEJS_12_X
        });
        customEmailSender.grantInvoke(new iam.ServicePrincipal("cognito-idp.amazonaws.com"));
        const emailSenderKey = new aws_kms_1.Key(this, prefix.concat("CustomEmailSenderKey"));
        const cognitoUserPool = new aws_cognito_1.UserPool(this, prefix.concat('cognitoUserPool'), {
            userPoolName: prefix.concat("loadtestidp"),
        });
        const appClient = cognitoUserPool.addClient("testusers", {
            authFlows: {
                adminUserPassword: true
            }
        });
        const createTestUserIds = new lambda.Function(this, 'createTestUserIds', {
            handler: "lambda_function.lambda_handler",
            code: new lambda.AssetCode(path.join(__dirname, 'lambda/createTestUserIds')),
            memorySize: 128,
            runtime: lambda.Runtime.PYTHON_3_8,
            timeout: cdk.Duration.seconds(3)
        });
        const secretManagerLayer = new lambda.LayerVersion(this, 'secretsLayer', {
            code: new lambda.AssetCode(path.join(__dirname, 'layers')),
            compatibleRuntimes: [lambda.Runtime.PYTHON_3_8],
            license: 'Apache-2.0',
            description: 'A layer for secret manager core functions',
        });
        secretManagerLayer.addPermission('account-grant', { accountId: this.account });
        const cleanUpTestUsers = new lambda.Function(this, 'cleanUpTestUsers', {
            handler: "lambda_function.lambda_handler",
            code: new lambda.AssetCode(path.join(__dirname, 'lambda/cleanUpTestUsers')),
            memorySize: 512,
            runtime: lambda.Runtime.PYTHON_3_8,
            timeout: cdk.Duration.seconds(600),
            layers: [secretManagerLayer],
            environment: {
                "client_id": appClient.userPoolClientId,
                "userpool_id": cognitoUserPool.userPoolId
            }
        });
        (_a = cleanUpTestUsers.role) === null || _a === void 0 ? void 0 : _a.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName('SecretsManagerReadWrite'));
        (_b = cleanUpTestUsers.role) === null || _b === void 0 ? void 0 : _b.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName('AmazonCognitoPowerUser'));
        const createTestUsers = new lambda.Function(this, 'createTestUsers', {
            handler: "lambda_function.lambda_handler",
            code: new lambda.AssetCode(path.join(__dirname, 'lambda/createTestUsers')),
            memorySize: 856,
            runtime: lambda.Runtime.PYTHON_3_8,
            timeout: cdk.Duration.seconds(900),
            layers: [secretManagerLayer],
            environment: {
                "client_id": appClient.userPoolClientId,
                "userpool_id": cognitoUserPool.userPoolId
            }
        });
        (_c = createTestUsers.role) === null || _c === void 0 ? void 0 : _c.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName('SecretsManagerReadWrite'));
        (_d = createTestUsers.role) === null || _d === void 0 ? void 0 : _d.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName('AmazonCognitoPowerUser'));
        const triggerLoadTestPerUser = new lambda.Function(this, 'triggerLoadTestPerUser', {
            handler: "lambda_function.lambda_handler",
            code: new lambda.AssetCode(path.join(__dirname, 'lambda/triggerLoadTestPerUser')),
            memorySize: 256,
            runtime: lambda.Runtime.PYTHON_3_8,
            timeout: cdk.Duration.seconds(900),
            layers: [secretManagerLayer],
            environment: {
                "numberOfCallsPerUser": "100",
                "client_id": appClient.userPoolClientId,
                "userpool_id": cognitoUserPool.userPoolId,
                "api_url": api_url.valueAsString
            }
        });
        (_e = triggerLoadTestPerUser.role) === null || _e === void 0 ? void 0 : _e.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName('SecretsManagerReadWrite'));
        (_f = triggerLoadTestPerUser.role) === null || _f === void 0 ? void 0 : _f.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName('AmazonCognitoPowerUser'));
        //STEP FUNCTIONS
        //LoadTestFanOut
        const createTestUserIdsJob = new tasks.LambdaInvoke(this, 'CreateTestUserIds', {
            lambdaFunction: createTestUserIds,
            inputPath: '$.users',
            resultPath: '$.taskResult'
        });
        //LoadTestCreateUsers   
        const createUsersJob = new tasks.LambdaInvoke(this, 'CreateTestUsers', {
            lambdaFunction: createTestUsers,
            inputPath: '$.users',
            resultPath: '$.createResult',
            outputPath: '$.taskResult.Payload.userNames'
        });
        const triggerLoadTestPerUserJob = new tasks.LambdaInvoke(this, 'TriggerLoadTest', {
            lambdaFunction: triggerLoadTestPerUser,
            resultPath: aws_stepfunctions_1.JsonPath.DISCARD
        });
        const definitionIterator = triggerLoadTestPerUserJob;
        const loadTestFanOut = new sfn.Map(this, 'LoadTestFanOut', {
            maxConcurrency: 0,
            inputPath: '$',
            resultPath: aws_stepfunctions_1.JsonPath.DISCARD
        });
        loadTestFanOut.iterator(definitionIterator);
        const jobValidateInput = new sfn.Choice(this, 'Is Input Valid?');
        const jobValidateNumericInput = new sfn.Fail(this, 'Input validation failed', {
            cause: 'Input Validation Failed. Please ensure NumberOfUser & NumberOfCallsPerUser do not exceed limits.',
            error: 'NumberOfUsers > 1000 OR NumberOfCallsPerUser > 1000',
        });
        const jobDone = new sfn.Pass(this, 'TestComplete', {});
        const coreDefinition = (createTestUserIdsJob)
            .next(createUsersJob)
            .next(loadTestFanOut)
            .next(jobDone);
        const definition = jobValidateInput
            .when(sfn.Condition.numberGreaterThan('$.users.NumberOfUsers', 1000), jobValidateNumericInput)
            .when(sfn.Condition.numberGreaterThan('$.users.NumberOfCallsPerUser', 1000), jobValidateNumericInput)
            .otherwise(coreDefinition);
        const createUsersAndFanOutLogGroup = new logs.LogGroup(this, 'CreateUsersAndFanOutLogGroup');
        new sfn.StateMachine(this, prefix.concat('CreateUsersAndFanOut'), {
            definition,
            logs: {
                destination: createUsersAndFanOutLogGroup,
                level: sfn.LogLevel.ALL
            }
        });
        //LoadTestDeleteUsers   
        const cleanUpTaskJob = new tasks.LambdaInvoke(this, 'CleanUpTask', {
            lambdaFunction: cleanUpTestUsers
        });
        const cleanUpTaskLogGroup = new logs.LogGroup(this, 'CleanUpTaskLogGroup');
        const cleanUpJobDone = new sfn.Pass(this, 'TestCleanUpComplete', {});
        const cleanUpDefinition = cleanUpTaskJob
            .next(cleanUpJobDone);
        new sfn.StateMachine(this, prefix.concat('DeleteTestUsers'), {
            definition: cleanUpDefinition,
            logs: {
                destination: cleanUpTaskLogGroup,
                level: sfn.LogLevel.ALL
            }
        });
        //END
        new cdk.CfnOutput(this, 'User Pool ID', {
            value: cognitoUserPool.userPoolId,
            description: 'User Pool ID',
            exportName: 'UserPoolID',
        });
        new cdk.CfnOutput(this, 'App Client ID', {
            value: appClient.userPoolClientId,
            description: 'App Client ID',
            exportName: 'AppClientID',
        });
        new cdk.CfnOutput(this, 'KMS Key', {
            value: emailSenderKey.keyArn,
            description: 'CustomEmailSender KMS Key ARN',
            exportName: 'CustomEmailSenderKMSKey',
        });
        new cdk.CfnOutput(this, 'CustomEmailSender Lambda', {
            value: customEmailSender.functionArn,
            description: 'CustomEmailSender lambda function',
            exportName: 'CustomEmailSenderLambdaARN',
        });
    }
}
const app = new cdk.App();
new LoadTestStack(app, 'aws-apiloadtest-framework', { description: "Serverless API Gateway Load Testing Framework." });
app.synth();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHFDQUFzQztBQUN0Qyw4Q0FBK0M7QUFDL0Msa0RBQW1EO0FBQ25ELHdDQUF5QztBQUN6QywwREFBMkQ7QUFDM0QsMENBQTJDO0FBQzNDLDZCQUE2QjtBQUM3Qiw4Q0FBdUM7QUFDdkMsc0RBQStDO0FBQy9DLHdDQUE2QztBQUM3QyxrRUFBc0Q7QUFFdEQsTUFBTSxhQUFjLFNBQVEsR0FBRyxDQUFDLEtBQUs7SUFDakMsWUFBWSxLQUFjLEVBQUUsRUFBVSxFQUFFLFFBQXdCLEVBQUU7O1FBQzlELEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRXhCLE1BQU0sTUFBTSxHQUFHLGNBQWMsQ0FBQTtRQUU3QixrQkFBa0I7UUFDbEIsTUFBTSxPQUFPLEdBQUcsSUFBSSxtQkFBWSxDQUFDLElBQUksRUFBRSxlQUFlLEVBQUU7WUFDdEQsSUFBSSxFQUFFLFFBQVE7WUFDZCxXQUFXLEVBQUUsb0NBQW9DO1NBQUMsQ0FBQyxDQUFDO1FBRXRELDZCQUE2QjtRQUM3QixNQUFNLGlCQUFpQixHQUFHLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsbUJBQW1CLEVBQUU7WUFDdkUsSUFBSSxFQUFFLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQywwQkFBMEIsQ0FBQztZQUN0RCxPQUFPLEVBQUUsZUFBZTtZQUN4QixPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXO1NBQ3BDLENBQUMsQ0FBQztRQUVILGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQywyQkFBMkIsQ0FBQyxDQUFDLENBQUM7UUFDckYsTUFBTSxjQUFjLEdBQUcsSUFBSSxhQUFHLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxNQUFNLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxD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QkFBK0I7WUFDNUMsVUFBVSxFQUFFLHlCQUF5QjtTQUN0QyxDQUFDLENBQUM7UUFFUCxJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLDBCQUEwQixFQUFFO1lBQzlDLEtBQUssRUFBRSxpQkFBaUIsQ0FBQyxXQUFXO1lBQ3BDLFdBQVcsRUFBRSxtQ0FBbUM7WUFDaEQsVUFBVSxFQUFFLDRCQUE0QjtTQUN6QyxDQUFDLENBQUM7SUFFWCxDQUFDO0NBQ0o7QUFFRCxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUMxQixJQUFJLGFBQWEsQ0FBQyxHQUFHLEVBQUUsMkJBQTJCLEVBQUUsRUFBQyxXQUFXLEVBQUUsZ0RBQWdELEVBQUMsQ0FBQyxDQUFDO0FBQ3JILEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjZGsgPSByZXF1aXJlKCdAYXdzLWNkay9jb3JlJyk7XG5pbXBvcnQgbGFtYmRhID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLWxhbWJkYScpO1xuaW1wb3J0IHNmbiA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2F3cy1zdGVwZnVuY3Rpb25zJyk7XG5pbXBvcnQgaWFtID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLWlhbScpO1xuaW1wb3J0IHRhc2tzID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLXN0ZXBmdW5jdGlvbnMtdGFza3MnKTtcbmltcG9ydCBsb2dzID0gcmVxdWlyZShcIkBhd3MtY2RrL2F3cy1sb2dzXCIpO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IEtleSB9IGZyb20gJ0Bhd3MtY2RrL2F3cy1rbXMnO1xuaW1wb3J0IHsgVXNlclBvb2wgfSBmcm9tICdAYXdzLWNkay9hd3MtY29nbml0bydcbmltcG9ydCB7IENmblBhcmFtZXRlciB9IGZyb20gJ0Bhd3MtY2RrL2NvcmUnO1xuaW1wb3J0IHsgSnNvblBhdGggfSBmcm9tICdAYXdzLWNkay9hd3Mtc3RlcGZ1bmN0aW9ucyc7XG5cbmNsYXNzIExvYWRUZXN0U3RhY2sgZXh0ZW5kcyBjZGsuU3RhY2sge1xuICAgIGNvbnN0cnVjdG9yKHNjb3BlOiBjZGsuQXBwLCBpZDogc3RyaW5nLCBwcm9wczogY2RrLlN0YWNrUHJvcHMgPSB7fSkge1xuICAgICAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHByZWZpeCA9IFwiYXBpbG9hZHRlc3QtXCJcblxuICAgICAgICAvL0lOUFVUIFBBUkFNRVRFUlNcbiAgICAgICAgY29uc3QgYXBpX3VybCA9IG5ldyBDZm5QYXJhbWV0ZXIodGhpcywgXCJhcGlHYXRld2F5VXJsXCIsIHtcbiAgICAgICAgICB0eXBlOiBcIlN0cmluZ1wiLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiBcIkFQSSBHYXRld2F5IFVSTCBiZWluZyBsb2FkIHRlc3RlZC5cIn0pO1xuXG4gICAgICAgIC8vVE9ETzogcmVnaXN0ZXIgd2l0aCBDb2duaXRvXG4gICAgICAgIGNvbnN0IGN1c3RvbUVtYWlsU2VuZGVyID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCAnY3VzdG9tRW1haWxTZW5kZXInLCB7XG4gICAgICAgICAgY29kZTogbmV3IGxhbWJkYS5Bc3NldENvZGUoJ2xhbWJkYS9jdXN0b21FbWFpbFNlbmRlcicpLFxuICAgICAgICAgIGhhbmRsZXI6ICdpbmRleC5oYW5kbGVyJyxcbiAgICAgICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTJfWFxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIGN1c3RvbUVtYWlsU2VuZGVyLmdyYW50SW52b2tlKG5ldyBpYW0uU2VydmljZVByaW5jaXBhbChcImNvZ25pdG8taWRwLmFtYXpvbmF3cy5jb21cIikpO1xuICAgICAgICBjb25zdCBlbWFpbFNlbmRlcktleSA9IG5ldyBLZXkodGhpcywgcHJlZml4LmNvbmNhdChcIkN1c3RvbUVtYWlsU2VuZGVyS2V5XCIpKVxuXG5cbiAgICAgICAgY29uc3QgY29nbml0b1VzZXJQb29sID0gbmV3IFVzZXJQb29sKHRoaXMsIHByZWZpeC5jb25jYXQoJ2NvZ25pdG9Vc2VyUG9vbCcpLCB7XG4gICAgICAgICAgICB1c2VyUG9vbE5hbWU6IHByZWZpeC5jb25jYXQoXCJsb2FkdGVzdGlkcFwiKSxcbiAgICAgICAgICAgIFxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBhcHBDbGllbnQgPSBjb2duaXRvVXNlclBvb2wuYWRkQ2xpZW50KFwidGVzdHVzZXJzXCIsIHtcbiAgICAgICAgICAgIGF1dGhGbG93czogeyAgICBcbiAgICAgICAgICAgICAgICBhZG1pblVzZXJQYXNzd29yZDogdHJ1ZVxuICAgICAgICAgICAgfX0pO1xuICAgICAgICBcblxuICAgICAgICBjb25zdCBjcmVhdGVUZXN0VXNlcklkcyA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgJ2NyZWF0ZVRlc3RVc2VySWRzJywge1xuICAgICAgICAgICAgICAgIGhhbmRsZXI6IFwibGFtYmRhX2Z1bmN0aW9uLmxhbWJkYV9oYW5kbGVyXCIsXG4gICAgICAgICAgICAgICAgY29kZTogbmV3IGxhbWJkYS5Bc3NldENvZGUocGF0aC5qb2luKF9fZGlybmFtZSwgJ2xhbWJkYS9jcmVhdGVUZXN0VXNlcklkcycpKSxcbiAgICAgICAgICAgICAgICBtZW1vcnlTaXplOiAxMjgsXG4gICAgICAgICAgICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuUFlUSE9OXzNfOCxcbiAgICAgICAgICAgICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcygzKVxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgICBjb25zdCBzZWNyZXRNYW5hZ2VyTGF5ZXIgPSBuZXcgbGFtYmRhLkxheWVyVmVyc2lvbih0aGlzLCAnc2VjcmV0c0xheWVyJywge1xuICAgICAgICAgICAgICBjb2RlOiBuZXcgbGFtYmRhLkFzc2V0Q29kZShwYXRoLmpvaW4oX19kaXJuYW1lLCAnbGF5ZXJzJykpLFxuICAgICAgICAgICAgICBjb21wYXRpYmxlUnVudGltZXM6IFtsYW1iZGEuUnVudGltZS5QWVRIT05fM184XSxcbiAgICAgICAgICAgICAgbGljZW5zZTogJ0FwYWNoZS0yLjAnLFxuICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJ0EgbGF5ZXIgZm9yIHNlY3JldCBtYW5hZ2VyIGNvcmUgZnVuY3Rpb25zJyxcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICBzZWNyZXRNYW5hZ2VyTGF5ZXIuYWRkUGVybWlzc2lvbignYWNjb3VudC1ncmFudCcsIHsgYWNjb3VudElkOiB0aGlzLmFjY291bnQgfSk7XG5cbiAgICAgICAgY29uc3QgY2xlYW5VcFRlc3RVc2VycyA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgJ2NsZWFuVXBUZXN0VXNlcnMnLCB7XG4gICAgICAgICAgICAgICAgaGFuZGxlcjogXCJsYW1iZGFfZnVuY3Rpb24ubGFtYmRhX2hhbmRsZXJcIixcbiAgICAgICAgICAgICAgICBjb2RlOiBuZXcgbGFtYmRhLkFzc2V0Q29kZShwYXRoLmpvaW4oX19kaXJuYW1lLCdsYW1iZGEvY2xlYW5VcFRlc3RVc2VycycpKSxcbiAgICAgICAgICAgICAgICBtZW1vcnlTaXplOiA1MTIsXG4gICAgICAgICAgICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuUFlUSE9OXzNfOCxcbiAgICAgICAgICAgICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcyg2MDApLFxuICAgICAgICAgICAgICAgIGxheWVyczogW3NlY3JldE1hbmFnZXJMYXllcl0sXG4gICAgICAgICAgICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiY2xpZW50X2lkXCI6IGFwcENsaWVudC51c2VyUG9vbENsaWVudElkLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJ1c2VycG9vbF9pZFwiOiBjb2duaXRvVXNlclBvb2wudXNlclBvb2xJZFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNsZWFuVXBUZXN0VXNlcnMucm9sZT8uYWRkTWFuYWdlZFBvbGljeShpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoJ1NlY3JldHNNYW5hZ2VyUmVhZFdyaXRlJykpO1xuICAgICAgICBjbGVhblVwVGVzdFVzZXJzLnJvbGU/LmFkZE1hbmFnZWRQb2xpY3koaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKCdBbWF6b25Db2duaXRvUG93ZXJVc2VyJykpO1xuXG4gICAgICAgIGNvbnN0IGNyZWF0ZVRlc3RVc2VycyA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgJ2NyZWF0ZVRlc3RVc2VycycsIHtcbiAgICAgICAgICAgICAgICBoYW5kbGVyOiBcImxhbWJkYV9mdW5jdGlvbi5sYW1iZGFfaGFuZGxlclwiLFxuICAgICAgICAgICAgICAgIGNvZGU6IG5ldyBsYW1iZGEuQXNzZXRDb2RlKHBhdGguam9pbihfX2Rpcm5hbWUsJ2xhbWJkYS9jcmVhdGVUZXN0VXNlcnMnKSksXG4gICAgICAgICAgICAgICAgbWVtb3J5U2l6ZTogODU2LFxuICAgICAgICAgICAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLlBZVEhPTl8zXzgsXG4gICAgICAgICAgICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLnNlY29uZHMoOTAwKSxcbiAgICAgICAgICAgICAgICBsYXllcnM6IFtzZWNyZXRNYW5hZ2VyTGF5ZXJdLFxuICAgICAgICAgICAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBcImNsaWVudF9pZFwiOiBhcHBDbGllbnQudXNlclBvb2xDbGllbnRJZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwidXNlcnBvb2xfaWRcIjogY29nbml0b1VzZXJQb29sLnVzZXJQb29sSWRcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBjcmVhdGVUZXN0VXNlcnMucm9sZT8uYWRkTWFuYWdlZFBvbGljeShpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoJ1NlY3JldHNNYW5hZ2VyUmVhZFdyaXRlJykpO1xuICAgICAgICBjcmVhdGVUZXN0VXNlcnMucm9sZT8uYWRkTWFuYWdlZFBvbGljeShpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoJ0FtYXpvbkNvZ25pdG9Qb3dlclVzZXInKSk7XG4gICAgICAgIFxuXG4gICAgICAgIGNvbnN0IHRyaWdnZXJMb2FkVGVzdFBlclVzZXIgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsICd0cmlnZ2VyTG9hZFRlc3RQZXJVc2VyJywge1xuICAgICAgICAgICAgICAgIGhhbmRsZXI6IFwibGFtYmRhX2Z1bmN0aW9uLmxhbWJkYV9oYW5kbGVyXCIsXG4gICAgICAgICAgICAgICAgY29kZTogbmV3IGxhbWJkYS5Bc3NldENvZGUocGF0aC5qb2luKF9fZGlybmFtZSwnbGFtYmRhL3RyaWdnZXJMb2FkVGVzdFBlclVzZXInKSksXG4gICAgICAgICAgICAgICAgbWVtb3J5U2l6ZTogMjU2LFxuICAgICAgICAgICAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLlBZVEhPTl8zXzgsXG4gICAgICAgICAgICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLnNlY29uZHMoOTAwKSxcbiAgICAgICAgICAgICAgICBsYXllcnM6IFtzZWNyZXRNYW5hZ2VyTGF5ZXJdLFxuICAgICAgICAgICAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBcIm51bWJlck9mQ2FsbHNQZXJVc2VyXCI6IFwiMTAwXCIsIC8vRGVmYXVsdCB2YWx1ZSwgY2FuIGFsc28gYmUgcGFzc2VkIGluIHdpdGhpbiBzdGVwIGZ1bmN0aW9uIGV4ZWN1dGlvbiBpbnB1dFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJjbGllbnRfaWRcIjogYXBwQ2xpZW50LnVzZXJQb29sQ2xpZW50SWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBcInVzZXJwb29sX2lkXCI6IGNvZ25pdG9Vc2VyUG9vbC51c2VyUG9vbElkLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJhcGlfdXJsXCI6IGFwaV91cmwudmFsdWVBc1N0cmluZ1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgdHJpZ2dlckxvYWRUZXN0UGVyVXNlci5yb2xlPy5hZGRNYW5hZ2VkUG9saWN5KGlhbS5NYW5hZ2VkUG9saWN5LmZyb21Bd3NNYW5hZ2VkUG9saWN5TmFtZSgnU2VjcmV0c01hbmFnZXJSZWFkV3JpdGUnKSk7XG4gICAgICAgIHRyaWdnZXJMb2FkVGVzdFBlclVzZXIucm9sZT8uYWRkTWFuYWdlZFBvbGljeShpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoJ0FtYXpvbkNvZ25pdG9Qb3dlclVzZXInKSk7XG5cblxuICAgICAgICAvL1NURVAgRlVOQ1RJT05TXG5cbiAgICAgICAgLy9Mb2FkVGVzdEZhbk91dFxuICAgICAgICBjb25zdCBjcmVhdGVUZXN0VXNlcklkc0pvYiA9IG5ldyB0YXNrcy5MYW1iZGFJbnZva2UodGhpcywgJ0NyZWF0ZVRlc3RVc2VySWRzJywge1xuICAgICAgICAgIGxhbWJkYUZ1bmN0aW9uOiBjcmVhdGVUZXN0VXNlcklkcyxcbiAgICAgICAgICBpbnB1dFBhdGg6ICckLnVzZXJzJyxcbiAgICAgICAgICByZXN1bHRQYXRoOiAnJC50YXNrUmVzdWx0J1xuICAgICAgICB9KTtcblxuICAgICAgICAvL0xvYWRUZXN0Q3JlYXRlVXNlcnMgICBcbiAgICAgICAgY29uc3QgY3JlYXRlVXNlcnNKb2IgPSBuZXcgdGFza3MuTGFtYmRhSW52b2tlKHRoaXMsICdDcmVhdGVUZXN0VXNlcnMnLCB7XG4gICAgICAgICAgbGFtYmRhRnVuY3Rpb246IGNyZWF0ZVRlc3RVc2VycyxcbiAgICAgICAgICBpbnB1dFBhdGg6ICckLnVzZXJzJyxcbiAgICAgICAgICByZXN1bHRQYXRoOiAnJC5jcmVhdGVSZXN1bHQnLFxuICAgICAgICAgIG91dHB1dFBhdGg6ICckLnRhc2tSZXN1bHQuUGF5bG9hZC51c2VyTmFtZXMnXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHRyaWdnZXJMb2FkVGVzdFBlclVzZXJKb2IgPSBuZXcgdGFza3MuTGFtYmRhSW52b2tlKHRoaXMsICdUcmlnZ2VyTG9hZFRlc3QnLCB7XG4gICAgICAgICAgbGFtYmRhRnVuY3Rpb246IHRyaWdnZXJMb2FkVGVzdFBlclVzZXIsXG4gICAgICAgICAgcmVzdWx0UGF0aDogSnNvblBhdGguRElTQ0FSRFxuICAgICAgICB9KTtcblxuXG4gICAgICAgIGNvbnN0IGRlZmluaXRpb25JdGVyYXRvciA9IHRyaWdnZXJMb2FkVGVzdFBlclVzZXJKb2I7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgIGNvbnN0IGxvYWRUZXN0RmFuT3V0ID0gbmV3IHNmbi5NYXAodGhpcywgJ0xvYWRUZXN0RmFuT3V0Jywge1xuICAgICAgICAgICAgbWF4Q29uY3VycmVuY3k6IDAsXG4gICAgICAgICAgICBpbnB1dFBhdGg6ICckJyxcbiAgICAgICAgICAgIHJlc3VsdFBhdGg6IEpzb25QYXRoLkRJU0NBUkRcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICBsb2FkVGVzdEZhbk91dC5pdGVyYXRvcihkZWZpbml0aW9uSXRlcmF0b3IpO1xuICAgICAgICBcbiAgICAgICAgY29uc3Qgam9iVmFsaWRhdGVJbnB1dCA9IG5ldyBzZm4uQ2hvaWNlKHRoaXMsICdJcyBJbnB1dCBWYWxpZD8nKTtcbiAgICAgICAgY29uc3Qgam9iVmFsaWRhdGVOdW1lcmljSW5wdXQgPSBuZXcgc2ZuLkZhaWwodGhpcywgJ0lucHV0IHZhbGlkYXRpb24gZmFpbGVkJywge1xuICAgICAgICAgICAgY2F1c2U6ICdJbnB1dCBWYWxpZGF0aW9uIEZhaWxlZC4gUGxlYXNlIGVuc3VyZSBOdW1iZXJPZlVzZXIgJiBOdW1iZXJPZkNhbGxzUGVyVXNlciBkbyBub3QgZXhjZWVkIGxpbWl0cy4nLFxuICAgICAgICAgICAgZXJyb3I6ICdOdW1iZXJPZlVzZXJzID4gMTAwMCBPUiBOdW1iZXJPZkNhbGxzUGVyVXNlciA+IDEwMDAnLFxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3Qgam9iRG9uZSA9IG5ldyBzZm4uUGFzcyh0aGlzLCAnVGVzdENvbXBsZXRlJywge30pO1xuXG5cbiAgICAgICAgY29uc3QgY29yZURlZmluaXRpb24gPSAoY3JlYXRlVGVzdFVzZXJJZHNKb2IpXG4gICAgICAgIC5uZXh0KGNyZWF0ZVVzZXJzSm9iKVxuICAgICAgICAubmV4dChsb2FkVGVzdEZhbk91dClcbiAgICAgICAgLm5leHQoam9iRG9uZSlcblxuICAgICAgICBjb25zdCBkZWZpbml0aW9uID0gXG4gICAgICAgIGpvYlZhbGlkYXRlSW5wdXRcbiAgICAgICAgICAgIC53aGVuKHNmbi5Db25kaXRpb24ubnVtYmVyR3JlYXRlclRoYW4oJyQudXNlcnMuTnVtYmVyT2ZVc2VycycsIDEwMDApLCBqb2JWYWxpZGF0ZU51bWVyaWNJbnB1dClcbiAgICAgICAgICAgIC53aGVuKHNmbi5Db25kaXRpb24ubnVtYmVyR3JlYXRlclRoYW4oJyQudXNlcnMuTnVtYmVyT2ZDYWxsc1BlclVzZXInLCAxMDAwKSwgam9iVmFsaWRhdGVOdW1lcmljSW5wdXQpXG4gICAgICAgICAgICAub3RoZXJ3aXNlKGNvcmVEZWZpbml0aW9uKVxuXG4gICAgICAgIGNvbnN0IGNyZWF0ZVVzZXJzQW5kRmFuT3V0TG9nR3JvdXAgPSBuZXcgbG9ncy5Mb2dHcm91cCh0aGlzLCAnQ3JlYXRlVXNlcnNBbmRGYW5PdXRMb2dHcm91cCcpO1xuXG4gICAgICAgIG5ldyBzZm4uU3RhdGVNYWNoaW5lKHRoaXMsIHByZWZpeC5jb25jYXQoJ0NyZWF0ZVVzZXJzQW5kRmFuT3V0JyksIHtcbiAgICAgICAgICAgIGRlZmluaXRpb24sXG4gICAgICAgICAgICBsb2dzOiB7XG4gICAgICAgICAgICAgICAgZGVzdGluYXRpb246IGNyZWF0ZVVzZXJzQW5kRmFuT3V0TG9nR3JvdXAsIFxuICAgICAgICAgICAgICAgIGxldmVsOiBzZm4uTG9nTGV2ZWwuQUxMXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG5cblxuICAgICAgICAvL0xvYWRUZXN0RGVsZXRlVXNlcnMgICBcbiAgICAgICAgY29uc3QgY2xlYW5VcFRhc2tKb2IgPSBuZXcgdGFza3MuTGFtYmRhSW52b2tlKHRoaXMsICdDbGVhblVwVGFzaycsIHtcbiAgICAgICAgICBsYW1iZGFGdW5jdGlvbjogY2xlYW5VcFRlc3RVc2Vyc1xuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGNsZWFuVXBUYXNrTG9nR3JvdXAgPSBuZXcgbG9ncy5Mb2dHcm91cCh0aGlzLCAnQ2xlYW5VcFRhc2tMb2dHcm91cCcpO1xuXG4gICAgICAgIGNvbnN0IGNsZWFuVXBKb2JEb25lID0gbmV3IHNmbi5QYXNzKHRoaXMsICdUZXN0Q2xlYW5VcENvbXBsZXRlJywge30pO1xuXG4gICAgICAgIGNvbnN0IGNsZWFuVXBEZWZpbml0aW9uID0gY2xlYW5VcFRhc2tKb2JcbiAgICAgICAgICAgIC5uZXh0KGNsZWFuVXBKb2JEb25lKVxuXG4gICAgICAgIG5ldyBzZm4uU3RhdGVNYWNoaW5lKHRoaXMsIHByZWZpeC5jb25jYXQoJ0RlbGV0ZVRlc3RVc2VycycpLCB7XG4gICAgICAgICAgICBkZWZpbml0aW9uOiBjbGVhblVwRGVmaW5pdGlvbixcbiAgICAgICAgICAgIGxvZ3M6IHtcbiAgICAgICAgICAgICAgICBkZXN0aW5hdGlvbjogY2xlYW5VcFRhc2tMb2dHcm91cCwgXG4gICAgICAgICAgICAgICAgbGV2ZWw6IHNmbi5Mb2dMZXZlbC5BTExcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy9FTkRcbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCAnVXNlciBQb29sIElEJywge1xuICAgICAgICAgICAgICB2YWx1ZTogY29nbml0b1VzZXJQb29sLnVzZXJQb29sSWQsXG4gICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnVXNlciBQb29sIElEJywgXG4gICAgICAgICAgICAgIGV4cG9ydE5hbWU6ICdVc2VyUG9vbElEJywgXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCAnQXBwIENsaWVudCBJRCcsIHtcbiAgICAgICAgICAgICAgdmFsdWU6IGFwcENsaWVudC51c2VyUG9vbENsaWVudElkLFxuICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJ0FwcCBDbGllbnQgSUQnLCBcbiAgICAgICAgICAgICAgZXhwb3J0TmFtZTogJ0FwcENsaWVudElEJywgXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCAnS01TIEtleScsIHtcbiAgICAgICAgICAgICAgdmFsdWU6IGVtYWlsU2VuZGVyS2V5LmtleUFybixcbiAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICdDdXN0b21FbWFpbFNlbmRlciBLTVMgS2V5IEFSTicsIFxuICAgICAgICAgICAgICBleHBvcnROYW1lOiAnQ3VzdG9tRW1haWxTZW5kZXJLTVNLZXknLCBcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsICdDdXN0b21FbWFpbFNlbmRlciBMYW1iZGEnLCB7XG4gICAgICAgICAgICAgIHZhbHVlOiBjdXN0b21FbWFpbFNlbmRlci5mdW5jdGlvbkFybixcbiAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICdDdXN0b21FbWFpbFNlbmRlciBsYW1iZGEgZnVuY3Rpb24nLCBcbiAgICAgICAgICAgICAgZXhwb3J0TmFtZTogJ0N1c3RvbUVtYWlsU2VuZGVyTGFtYmRhQVJOJywgXG4gICAgICAgICAgICB9KTtcblxuICAgIH1cbn1cblxuY29uc3QgYXBwID0gbmV3IGNkay5BcHAoKTtcbm5ldyBMb2FkVGVzdFN0YWNrKGFwcCwgJ2F3cy1hcGlsb2FkdGVzdC1mcmFtZXdvcmsnLCB7ZGVzY3JpcHRpb246IFwiU2VydmVybGVzcyBBUEkgR2F0ZXdheSBMb2FkIFRlc3RpbmcgRnJhbWV3b3JrLlwifSk7XG5hcHAuc3ludGgoKTtcbiJdfQ==